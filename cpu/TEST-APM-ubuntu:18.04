FROM ubuntu:18.04

##Apache install

RUN apt-get update && apt-get install apache2 -y

#RUN sed -i "s/Listen 80/Listen 8080/g" /etc/apache2/ports.conf

RUN echo "ServerName 127.0.0.1" >> /etc/apache2/apache2.conf


##PHP install

RUN apt-get install -y software-properties-common
# PPA를 사용할 때 쓰는 add-apt-repository 명령어를 사용하기 위한 software-properties 설치
RUN add-apt-repository ppa:ondrej/php
# add-apt-repository <저장소이름>   -> 저장소 추가하기
RUN apt-get install -y php 


##MySQL install

ENV DEBIAN_FRONTEND noninteractive
# 추가적인 입력 요구 사전 방지
RUN echo exit 0> /usr/sbin/policy-rc.d

RUN echo "mysql-server mysql-server/root_password password" | debconf-set-selections

RUN echo "mysql-server mysql-server/root_password_again password" | debconf-set-selections

RUN apt-get install -y mysql-server

RUN sed -i "s/127.0.0.1/0.0.0.0/g" /etc/mysql/my.cnf

#RUN sed -i "s/3306/3307/g" /etc/mysql/my.cnf

RUN apt-get install -y mysql-server


##port open
EXPOSE 80
EXPOSE 3306


RUN mkdir -p /var/run/sshd

ADD . /var/run/sshd

WORKDIR /var/run/sshd

RUN chmod 755 apm.sh 
# cat apm.sh
# source /etc/apache2/envvars
# /usr/sbin/apache2
# /usr/sbin/sshd -D
# + while문 추가로 apache와 ssh를 종료해도 컨테이너가 종료되지 않도록 설정

CMD ["/bin/bash", "./apm.sh"]
